---
title: Update Tristan - Impl√©mentation Authentification Supabase
date: 2025-11-26
author: Augment Agent
---

# üîê Mise √† jour Authentification Kareer

## üìã R√©sum√© des Modifications

Cette mise √† jour remplace le syst√®me d'authentification mock par une int√©gration compl√®te avec Supabase Auth, incluant la gestion des mots de passe temporaires.

---

## üìÅ Fichiers Modifi√©s

### 1. `src/lib/auth.tsx` ‚úèÔ∏è MODIFI√â

**Objectif**: Remplacer le syst√®me mock par Supabase Auth r√©el

**Changements cl√©s**:
- ‚ùå Suppression des `MOCK_USERS` (utilisateurs de d√©monstration)
- ‚ùå Suppression du stockage localStorage manuel
- ‚úÖ Int√©gration avec `supabase.auth.signInWithPassword()`
- ‚úÖ Ajout de `mustChangePassword` dans le contexte
- ‚úÖ Fonction `updatePassword()` pour changer le mot de passe
- ‚úÖ D√©tection automatique du r√¥le utilisateur via les tables m√©tier
- ‚úÖ √âcoute des √©v√©nements auth (SIGNED_IN, SIGNED_OUT, USER_UPDATED)

**Nouveau type User**:
```typescript
export interface User {
  id: string;
  name: string;
  email: string;
  role: 'student' | 'coach' | 'admin' | 'school_admin' | 'super_admin';
  avatarUrl?: string;
  mustChangePassword?: boolean;
}
```

**Nouveau contexte**:
```typescript
interface AuthContextType {
  user: User | null;
  isLoading: boolean;
  isAuthenticated: boolean;
  mustChangePassword: boolean;           // NOUVEAU
  login: (email, password) => Promise<LoginResult>;
  logout: () => Promise<void>;
  checkAuth: () => Promise<boolean>;
  updatePassword: (newPassword) => Promise<void>;  // NOUVEAU
  clearMustChangePassword: () => void;   // NOUVEAU
}
```

---

### 2. `src/screens/ChangePassword/ChangePassword.tsx` ‚úÖ CR√â√â

**Objectif**: Page obligatoire de changement de mot de passe temporaire

**Fonctionnalit√©s**:
- üîí Affichage de l'email de l'utilisateur connect√©
- üìä Indicateur de force du mot de passe (barre de progression)
- ‚úÖ Liste des exigences du mot de passe avec validation en temps r√©el:
  - Au moins 8 caract√®res
  - Une majuscule
  - Une minuscule
  - Un chiffre
  - Un caract√®re sp√©cial
- üëÅÔ∏è Toggle visibilit√© mot de passe
- ‚úÖ Confirmation que les mots de passe correspondent
- üîÑ Redirection automatique vers le dashboard apr√®s succ√®s
- üö™ Option de d√©connexion

**Style**: Coh√©rent avec le design existant (Tailwind CSS, composants UI)

---

### 3. `src/screens/ChangePassword/index.ts` ‚úÖ CR√â√â

**Objectif**: Export du composant ChangePassword

```typescript
export { ChangePassword } from './ChangePassword';
```

---

### 4. `src/screens/LoginPage/LoginPage.tsx` ‚úèÔ∏è MODIFI√â

**Objectif**: G√©rer la redirection vers /change-password

**Changements**:
- ‚ùå Suppression du pr√©-remplissage automatique des champs (mode d√©mo)
- ‚ùå Suppression des useEffect qui remplissaient email/password
- ‚úÖ V√©rification de `mustChangePassword` apr√®s login
- ‚úÖ Redirection vers `/change-password` si n√©cessaire
- ‚úÖ Gestion des erreurs Supabase sp√©cifiques:
  - "Invalid login credentials"
  - "Email not confirmed"

**Nouveau flux de login**:
```typescript
const result = await login(email, password);

if (result.mustChangePassword) {
  navigate('/change-password');  // ‚Üê Mot de passe temporaire
  return;
}

// Sinon, acc√®s normal au dashboard
navigate(result.user.role === 'coach' ? '/coach' : '/dashboard');
```

---

### 5. `src/App.tsx` ‚úèÔ∏è MODIFI√â

**Objectif**: Ajouter la route /change-password et prot√©ger les routes

**Changements**:
- ‚úÖ Import de `ChangePassword`
- ‚úÖ Modification de `ProtectedRoute` pour v√©rifier `mustChangePassword`
- ‚úÖ Cr√©ation de `RequirePasswordChange` (route sp√©ciale)
- ‚úÖ Ajout de la route `/change-password`

**Nouveau comportement ProtectedRoute**:
```typescript
const ProtectedRoute = ({ children }) => {
  const { isAuthenticated, isLoading, mustChangePassword } = useAuth();
  
  if (isLoading) return <Loading />;
  if (!isAuthenticated && !BYPASS) return <Navigate to="/login" />;
  
  // NOUVEAU: Redirection si mot de passe temporaire
  if (mustChangePassword && !BYPASS) {
    return <Navigate to="/change-password" />;
  }
  
  return children;
};
```

---

## üîÑ Flux Complet d'Authentification

```mermaid
sequenceDiagram
    participant U as Utilisateur
    participant LP as LoginPage
    participant Auth as AuthContext
    participant SB as Supabase Auth
    participant CP as ChangePassword
    participant DB as Dashboard

    U->>LP: Entre email + mot de passe temporaire
    LP->>Auth: login(email, password)
    Auth->>SB: signInWithPassword()
    SB-->>Auth: { user, session }
    Auth-->>LP: { user, mustChangePassword: true }
    
    alt mustChangePassword = true
        LP->>CP: navigate('/change-password')
        U->>CP: Entre nouveau mot de passe
        CP->>Auth: updatePassword(newPassword)
        Auth->>SB: updateUser({ password })
        Auth->>SB: updateUser({ data: { must_change_password: false }})
        SB-->>Auth: Success
        CP->>DB: navigate('/dashboard')
    else mustChangePassword = false
        LP->>DB: navigate('/dashboard')
    end
```

---

## üõ°Ô∏è S√©curit√©

### Exigences Mot de Passe
| Crit√®re | Valeur |
|---------|--------|
| Longueur minimale | 8 caract√®res |
| Majuscules | Au moins 1 |
| Minuscules | Au moins 1 |
| Chiffres | Au moins 1 |
| Caract√®res sp√©ciaux | Au moins 1 (!@#$%^&*...) |

### Protection des Routes
- Toutes les routes prot√©g√©es redirigent vers `/change-password` si `mustChangePassword: true`
- La route `/change-password` n√©cessite d'√™tre authentifi√©
- Impossible d'acc√©der au dashboard sans avoir chang√© le mot de passe temporaire

---

## üóÑÔ∏è Interaction avec Supabase

### Tables utilis√©es pour d√©terminer le r√¥le
1. `super_admins` ‚Üí role: 'super_admin'
2. `school_admins` ‚Üí role: 'school_admin'
3. `coaches` ‚Üí role: 'coach'
4. `students` ‚Üí role: 'student'

### M√©tadonn√©es utilisateur (user_metadata)
```json
{
  "account_type": "student",
  "full_name": "Jean Dupont",
  "must_change_password": true,
  "first_login": true,
  "avatar_url": ""
}
```

### Apr√®s changement de mot de passe
```json
{
  "must_change_password": false,
  "first_login": false,
  "password_changed_at": "2025-11-26T12:00:00.000Z"
}
```

---

## ‚úÖ Checklist de V√©rification

- [x] auth.tsx utilise Supabase Auth
- [x] Page /change-password cr√©√©e
- [x] LoginPage redirige vers /change-password si n√©cessaire
- [x] ProtectedRoute v√©rifie mustChangePassword
- [x] Route /change-password ajout√©e dans App.tsx
- [x] Pas de modification du design existant
- [x] Validation de force du mot de passe
- [x] Gestion des erreurs Supabase

---

## üöÄ Prochaines √âtapes Sugg√©r√©es

1. **Tester le flux complet**:
   - Cr√©er un utilisateur via Edge Function `create-user-account`
   - Se connecter avec le mot de passe temporaire
   - V√©rifier la redirection vers /change-password
   - Changer le mot de passe
   - V√©rifier l'acc√®s au dashboard

2. **Variables d'environnement requises**:
   ```env
   VITE_SUPABASE_URL=https://rnmgjstdnttfljqtvrxu.supabase.co
   VITE_SUPABASE_ANON_KEY=votre_cl√©_anon
   ```

3. **Mode d√©veloppement** (optionnel):
   ```env
   VITE_BYPASS_AUTH=true  # D√©sactive toutes les protections
   ```

---

## üîÑ Update 2 - Corrections UX Login

### Probl√®mes corrig√©s

| Probl√®me | Solution |
|----------|----------|
| Page login affich√©e alors que d√©j√† connect√© | Ajout d'un loader pendant `authLoading` |
| Bouton "Aller √† l'App" redirige vers /login | Chang√© vers `/dashboard` (route prot√©g√©e) |
| Onglets √©tudiant/coach qui ne servent √† rien | Supprim√©s - formulaire unique |

### Fichiers modifi√©s (Update 2)

#### `src/components/LandingHeader.tsx`
- Chang√© `<Link to="/login">` ‚Üí `<Link to="/dashboard">`
- L'utilisateur connect√© est redirig√© directement vers son dashboard
- L'utilisateur non connect√© est redirig√© vers /login par ProtectedRoute

#### `src/screens/LoginPage/LoginPage.tsx`
- **Ajout loader** : Affiche un spinner pendant que l'auth v√©rifie la session
- **Suppression onglets** : Plus de tabs √©tudiant/coach
- **Formulaire unique** : Design bleu conserv√©, un seul formulaire
- **Suppression `loginOptions`** : Plus besoin de cette configuration
- **Suppression imports Tabs** : Code nettoy√©

### Nouveau flux de login

```
1. Utilisateur clique "Aller √† l'App"
   ‚Üì
2. Redirig√© vers /dashboard (route prot√©g√©e)
   ‚Üì
3. ProtectedRoute v√©rifie l'authentification
   ‚Üì
4a. Si connect√© ‚Üí Affiche Dashboard
4b. Si non connect√© ‚Üí Redirige vers /login
   ‚Üì
5. LoginPage v√©rifie authLoading
   ‚Üì
6a. Si authLoading=true ‚Üí Affiche loader
6b. Si authLoading=false ‚Üí Affiche formulaire
```

---

## üìû Support

Pour toute question sur cette mise √† jour, contactez l'√©quipe technique.

**Fichiers cr√©√©s**: 2
**Fichiers modifi√©s**: 4
**Lignes de code ajout√©es**: ~450

